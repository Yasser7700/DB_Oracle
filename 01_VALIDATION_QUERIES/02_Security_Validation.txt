================================================================================
                  استعلامات التحقق من الأمان
                   نظام التجارة الإلكترونية الآمن
================================================================================

╔══════════════════════════════════════════════════════════════════════════════╗
║                    1. اختبار تسجيل الدخول                                    ║
╚══════════════════════════════════════════════════════════════════════════════╝

-- اختبر تسجيل الدخول بكل مستخدم:
-- sqlplus ECOM_OWNER/EcomOwner#2024@localhost:1521/ECOM_PDB
-- sqlplus CS_AGENT/CsAgent#2024@localhost:1521/ECOM_PDB
-- sqlplus WAREHOUSE_STAFF/Warehouse#2024@localhost:1521/ECOM_PDB

-- التحقق من المستخدم الحالي
SELECT USER, SYS_CONTEXT('USERENV','CON_NAME') AS PDB FROM DUAL;

╔══════════════════════════════════════════════════════════════════════════════╗
║                    2. اختبار RBAC                                            ║
╚══════════════════════════════════════════════════════════════════════════════╝

-- عرض الأدوار للمستخدم الحالي
SELECT * FROM SESSION_ROLES;

-- عرض الصلاحيات
SELECT * FROM SESSION_PRIVS;

-- اختبار الوصول للجداول (نفذ كل اختبار بالمستخدم المناسب):

-- كمستخدم CS_AGENT:
SELECT COUNT(*) FROM ECOM_OWNER.CUSTOMERS; -- يجب أن ينجح
SELECT * FROM ECOM_OWNER.PAYMENTS; -- يجب أن يفشل أو يعرض بيانات محدودة

-- كمستخدم WAREHOUSE_STAFF:
SELECT COUNT(*) FROM ECOM_OWNER.ORDERS; -- يجب أن ينجح
UPDATE ECOM_OWNER.ORDERS SET TRACKING_NUMBER = 'TEST' WHERE 1=0; -- يجب أن ينجح
UPDATE ECOM_OWNER.ORDERS SET TOTAL_AMOUNT = 0 WHERE 1=0; -- يجب أن يفشل

╔══════════════════════════════════════════════════════════════════════════════╗
║                    3. اختبار VPD                                             ║
╚══════════════════════════════════════════════════════════════════════════════╝

-- كمستخدم CS_AGENT:
SELECT COUNT(*) FROM ECOM_OWNER.CUSTOMERS;
-- يجب أن يعرض فقط العملاء المعينين لـ CS_AGENT أو بدون تعيين

-- كمستخدم ECOM_OWNER أو SYS:
SELECT COUNT(*) FROM ECOM_OWNER.CUSTOMERS;
-- يجب أن يعرض جميع العملاء

╔══════════════════════════════════════════════════════════════════════════════╗
║                    4. اختبار Data Redaction                                  ║
╚══════════════════════════════════════════════════════════════════════════════╝

-- كمستخدم CS_AGENT:
SELECT CUSTOMER_ID, EMAIL, PHONE, NATIONAL_ID FROM ECOM_OWNER.CUSTOMERS WHERE ROWNUM <= 3;
-- يجب أن تظهر البيانات مخفية جزئياً

-- كمستخدم ECOM_OWNER:
SELECT CUSTOMER_ID, EMAIL, PHONE, NATIONAL_ID FROM ECOM_OWNER.CUSTOMERS WHERE ROWNUM <= 3;
-- يجب أن تظهر البيانات كاملة (للمسؤولين)

╔══════════════════════════════════════════════════════════════════════════════╗
║                    5. اختبار التدقيق                                         ║
╚══════════════════════════════════════════════════════════════════════════════╝

-- تنفيذ عملية للتدقيق
SELECT * FROM ECOM_OWNER.CUSTOMERS WHERE ROWNUM = 1;

-- التحقق من سجلات التدقيق (كـ AUDITOR أو SYS)
SELECT EVENT_TIMESTAMP, DBUSERNAME, ACTION_NAME, OBJECT_NAME
FROM UNIFIED_AUDIT_TRAIL
WHERE OBJECT_OWNER = 'ECOM_OWNER'
AND EVENT_TIMESTAMP > SYSTIMESTAMP - INTERVAL '1' HOUR
ORDER BY EVENT_TIMESTAMP DESC
FETCH FIRST 10 ROWS ONLY;

╔══════════════════════════════════════════════════════════════════════════════╗
║                    6. اختبار كلمات المرور                                    ║
╚══════════════════════════════════════════════════════════════════════════════╝

-- اختبار سياسة كلمة المرور (يجب أن تفشل):
-- ALTER USER CS_AGENT IDENTIFIED BY weak;
-- يجب أن تظهر رسالة خطأ عن تعقيد كلمة المرور

-- اختبار قفل الحساب:
-- حاول تسجيل الدخول 5 مرات بكلمة مرور خاطئة
-- ثم تحقق من حالة الحساب:
SELECT USERNAME, ACCOUNT_STATUS FROM DBA_USERS WHERE USERNAME = 'CS_AGENT';

╔══════════════════════════════════════════════════════════════════════════════╗
║                    7. ملخص الاختبارات                                        ║
╚══════════════════════════════════════════════════════════════════════════════╝

الاختبار                              │ المتوقع                  │ النتيجة
──────────────────────────────────────┼──────────────────────────┼─────────
تسجيل دخول بكلمة مرور صحيحة          │ نجاح                     │ [ ]
تسجيل دخول بكلمة مرور خاطئة          │ فشل                      │ [ ]
CS_AGENT يقرأ CUSTOMERS               │ نجاح (بيانات محدودة)    │ [ ]
CS_AGENT يقرأ PAYMENTS                │ فشل أو بيانات مخفية     │ [ ]
WAREHOUSE يحدث TRACKING_NUMBER        │ نجاح                     │ [ ]
WAREHOUSE يحدث TOTAL_AMOUNT           │ فشل                      │ [ ]
البريد مخفي لـ CS_AGENT               │ ****@domain.com         │ [ ]
الهوية مخفية لـ CS_AGENT              │ XXXX****1234            │ [ ]
سجلات التدقيق تظهر العمليات           │ نجاح                     │ [ ]

================================================================================
                         نهاية اختبارات الأمان
================================================================================
